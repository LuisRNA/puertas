<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de Puertas </title>
  <style>
    :root {
      --bg:#0b1020; --panel:#141b36; --ink:#e8ecff; --accent:#7aa2f7;
      --ok:#a6e3a1; --warn:#ffb4a9;

      /* Paleta madera (Prueba + Fase 1) */
      --door-border:#8a6e4b;
      --wood1:#7a4f2a;
      --wood2:#5b3a1c;
      --wood-sheen:rgba(255,255,255,.06);
      --knob:#c8ccd4;

      /* Paleta Fase 2 (rojo amigable) */
      --p2-border:#d07a7a;
      --p2-wood1:#c65d5d;
      --p2-wood2:#9e3f3f;

      --door-label-bg: rgba(255,255,255,0);
      --instruction-glow: 0 0 0 3px rgba(166,227,161,.55), 0 0 22px rgba(166,227,161,.35), inset 0 0 0 2px rgba(255,255,255,.12);
    }
    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      display:flex; align-items:center; justify-content:center;
    }
    .app { width:min(960px, 92vw); }
    .card {
      background:var(--panel); border:2px solid var(--accent);
      border-radius:16px; padding:22px 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1,h2,h3 { margin:0 0 12px 0; }
    .center { text-align:center; }
    .meta { font-size:14px; opacity:.85; }
    .small { font-size:14px; }
    .spacer { height:14px; }
    .footer { margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .field { display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; }

    .btn {
      appearance:none; border:2px solid var(--accent); background:#0f1530; color:var(--ink);
      padding:12px 18px; border-radius:12px; font-size:18px; cursor:pointer; transition: transform .05s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .btn.secondary { border-color:#566; opacity:.9; }

    label { font-size:16px; }
    input[type="text"], input[type="number"], select, input[type="password"], textarea {
      background:#0f1530; color:var(--ink); border:2px solid #3b4261; border-radius:10px; padding:8px 10px; font-size:16px;
    }
    textarea { width:min(680px, 86vw); resize:vertical; }

    /* === Puertas (base: madera para instrucciones, Prueba y Fase 1) === */
    .doors { display:flex; gap:28px; justify-content:center; flex-wrap:wrap; margin-top:10px; perspective: 900px; }
    .door {
      width:180px; height:240px; position:relative; border-radius:16px; cursor:pointer;
      border:3px solid var(--door-border);
      background:
        linear-gradient(160deg, var(--wood1), var(--wood2)),
        linear-gradient(180deg, var(--wood-sheen), rgba(0,0,0,.10));
      box-shadow: 0 8px 18px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.04);
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease, filter .2s ease;
      transform-style: preserve-3d;
    }
    .door:hover { transform: translateY(-2px); filter: saturate(1.02); }
    .door:active { transform: translateY(0); }
    .door.alt { } /* sin diferencias */
    .door.selected-instruction {
      border-color: var(--ok);
      box-shadow: var(--instruction-glow);
      filter: saturate(1.06);
    }
    .door-arch {
      position:absolute; inset: 16px 16px auto 16px; height: 56%;
      border-radius: 12px 12px 40% 40% / 14px 14px 50% 50%;
      background:
        radial-gradient(120px 80px at 50% 0%, rgba(255,255,255,.10), rgba(255,255,255,0) 70%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.12));
      border:2px solid rgba(255,255,255,.06);
    }
    .door-knob {
      position:absolute; right:20px; top: calc(50% + 16px);
      width:14px; height:14px;
      background: radial-gradient(circle at 30% 30%, #fff6, #0006), var(--knob);
      border-radius:50%;
      box-shadow: 0 0 0 2px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.35);
    }
    .door-label { display:none; }
    .door[disabled] { cursor:default; opacity: .98; }

    /* === Tema Fase 2 (rojo) === */
    body.phase2-theme .door {
      border-color: var(--p2-border);
      background:
        linear-gradient(160deg, var(--p2-wood1), var(--p2-wood2)),
        linear-gradient(180deg, var(--wood-sheen), rgba(0,0,0,.10));
    }

    /* Animaci√≥n de apertura */
    .door.opening { animation: doorOpen 700ms ease forwards; pointer-events: none; }
    @keyframes doorOpen {
      0%   { transform: translateY(-2px) rotateY(0deg); }
      55%  { transform: translateY(0) rotateY(-16deg); }
      100% { transform: translateY(0) rotateY(-74deg); }
    }

    /* Feedback */
    .feedback-wrap { display:flex; flex-direction:column; align-items:center; gap:8px; margin-top:10px; }
    .feedback-symbol { font-size:110px; line-height:1; max-width:140px; max-height:140px; }
    .points { font-size:42px; font-weight:800; letter-spacing:1px; margin-top:4px; }
    .points.ok { color: var(--ok); }
    .points.no { color: var(--warn); }

    .example-grid { display:flex; gap:24px; justify-content:center; flex-wrap:wrap; margin-top:8px; }
    .example-card { width:210px; padding:14px 12px; border-radius:14px; border:2px dashed rgba(255,255,255,.2); background: rgba(255,255,255,.04); }

    /* Subpuertas laterales */
    .subdoors { display:flex; justify-content:space-between; align-items:flex-start; gap:20px; margin-top:10px; }
    .subslot { width:45%; display:flex; gap:28px; }
    .subslot.left { justify-content:flex-start; }
    .subslot.right { justify-content:flex-end; }
    .subslot.empty { min-height:240px; }

    /* Botones de selecci√≥n (S√≠/No / Todas) */
    .choices { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin:10px 0; }
    .choice {
      appearance:none; border:2px solid #3b4261; background:#0f1530; color:var(--ink);
      padding:10px 16px; border-radius:12px; font-size:18px; cursor:pointer;
      transition: box-shadow .2s ease, border-color .2s ease, transform .05s ease;
    }
    .choice:hover { transform: translateY(-1px); }
    .choice.selected {
      border-color: var(--ok);
      box-shadow: var(--instruction-glow);
      filter: saturate(1.04);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card" id="screen"></div>
  </div>

  <script>
  /* ====== Config env√≠o (puedes dejar vac√≠o si no usas Sheets) ====== */
  const SHEETS_URL = '';
  const ADMIN_PASS = 'GBM_Puertas';

  let __rowsSent = false;
  async function sendToSheets(rows){ if(!SHEETS_URL||__rowsSent) return; try{
    await fetch(SHEETS_URL,{method:'POST',mode:'no-cors',keepalive:true,headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(rows)});__rowsSent=true;
  }catch(e){ try{ const b=new Blob([JSON.stringify(rows)],{type:'text/plain;charset=utf-8'}); if(navigator.sendBeacon(SHEETS_URL,b)) __rowsSent=true;}catch(_){}}}
  window.addEventListener('pagehide',()=>{ if(!__rowsSent&&state.rows&&state.rows.length){ try{ const b=new Blob([JSON.stringify(state.rows)],{type:'application/json'}); navigator.sendBeacon(SHEETS_URL,b); __rowsSent=true;}catch(_){}}});

  /* ====== Utilidades ====== */
  function getParam(name, fallback=null){ const url=new URL(window.location.href); const v=url.searchParams.get(name); return v!==null?v:fallback; }
  function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function now(){ return performance.now(); }
  function secs(ms){ return (ms/1000).toFixed(2); }
  function download(filename, content, type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
  const CSV_HEADERS=['Num_Ensayo','Tiempo_Global','Tiempo_ENT','Tiempo_F1','Tiempo_F2','Respuesta','Res_Correcta','Fase','Grupo','Puerta_F2','Edad','Genero','Semestre','ID','rt_primera','rt_segunda','Detecto_Regla','Regla_Texto','Detecto_Estrategia','Estrategia_Texto','Mas_Monedas_F1','Menos_Monedas_F1','Mas_Monedas_F2','Menos_Monedas_F2','Comentario'];
  function toCSVOrdered(rows, headers){ if(!rows.length) return headers.join(','); const esc=v=>{ if(v===null||v===undefined) return ''; const s=String(v).replaceAll('"','""'); return /[",\n]/.test(s)?'"'+s+'"':s; }; const lines=[headers.join(',')]; for(const r of rows) lines.push(headers.map(h=>esc(r[h])).join(',')); return lines.join('\n'); }

  /* ====== Componentes ====== */
  function doorHTML(id,label,alt=false){ return `
    <button class="door ${alt?'alt':''}" id="${id}" aria-label="Puerta">
      <span class="door-arch" aria-hidden="true"></span>
      <span class="door-knob" aria-hidden="true"></span>
      <span class="door-label" aria-hidden="true"></span>
    </button>`; }
  function feedbackHTML(rewarded){
    const symbol=rewarded?'ü™ô':'‚ùå', points=rewarded?'+1':'+0', cls=rewarded?'ok':'no';
    return `<div class="feedback-wrap"><div class="feedback-symbol">${symbol}</div><div class="points ${cls}">${points}</div></div>`;
  }

  /* ====== Config experimento ====== */
  const URL_MODE=(getParam('mode','noreplacement').toLowerCase()==='replacement')?'replacement':'noreplacement';
  const URL_TRIALS=Math.max(1, parseInt(getParam('trials','40'))||40);
  const PRACTICE_TRIALS=10;
  const SEQS=['II','ID','DI','DD'];
  const DOOR_ANIM_MS=700;

  // Fase 2: forbid por URL
  const URL_FORBID=(getParam('forbid','')||'').toUpperCase().trim();
  function forbidIndexFromParam(v){ if(!v) return null; const map={II:0,ID:1,DI:2,DD:3,A1:0,A2:1,B1:2,B2:3}; return (v in map)?map[v]:null; }

  const state={
    phase:'main', programMode:URL_MODE, maxTrials:URL_TRIALS,
    phase2_forbidden:null,
    trial:0, globalTrial:0, block:1,
    currentTarget:null, remainingTargets:[],
    firstChoice:null, secondChoice:null,
    sessionStartMs:null, entStartMs:null, f1StartMs:null, f2StartMs:null,
    trialStartMs:null, firstChoiceMs:null,
    tmpRTPrimera:null, tmpRTSegunda:null,
    rows:[],
    edad:null, genero:null, semestre:null, participantID:null,
    instr_firstChoice:null, instr_secondChoice:null,
    coinsF1:0, coinsF2:0,
    // Cuestionario final
    postRuleDetected:null,     // 'Si' | 'No'
    postRuleText:'',
    postStrategyDetected:null, // 'Si' | 'No'
    postStrategyText:'',
    postF1MoreCoins:null,      // 'II' | 'ID' | 'DI' | 'DD' | 'Todas'
    postF1LessCoins:null,      // 'II' | 'ID' | 'DI' | 'DD' | 'Todas'
    postF2MoreCoins:null,      // idem para F2
    postF2LessCoins:null,
    postComment:''             // ‚Üê NUEVO: comentario final
  };

  function phaseCode(){ return state.phase==='practice'?'ENT':(state.phase==='main'?'F1':'F2'); }
  function groupLabel(){ return state.programMode==='replacement'?'Reemplazo':'No_Reemplazo'; }
  function forbiddenSeqLabel(){ return (state.phase==='phase2'&&state.phase2_forbidden!==null)?SEQS[state.phase2_forbidden]:'0'; }
  function allowedPool(){ let pool=[0,1,2,3]; if(state.phase==='phase2'&&state.phase2_forbidden!==null){ pool=pool.filter(i=>i!==state.phase2_forbidden);} return pool; }
  function initProgram(){ const pool=allowedPool(); if(state.programMode==='noreplacement'){ state.remainingTargets=shuffle(pool); state.currentTarget=state.remainingTargets[0]; } else { state.currentTarget=pool[Math.floor(Math.random()*pool.length)]; } }
  function advanceOnReward(){ const pool=allowedPool(); if(state.programMode==='noreplacement'){ state.remainingTargets.shift(); if(state.remainingTargets.length===0){ state.block+=1; state.remainingTargets=shuffle(pool);} state.currentTarget=state.remainingTargets[0]; } else { state.currentTarget=pool[Math.floor(Math.random()*pool.length)]; } }

  const screen=document.getElementById('screen');
  function html(strings,...vals){ return strings.map((s,i)=>s+(i<vals.length?vals[i]:'' )).join(''); }
  function subdoorsHTML(first){
    const showA=first==='A', showB=first==='B';
    const left = showA ? `${doorHTML('opt0','A1',false)}${doorHTML('opt1','A2',true)}` : '';
    const right= showB ? `${doorHTML('opt0','B1',false)}${doorHTML('opt1','B2',true)}` : '';
    return `<div class="subdoors"><div class="subslot left ${showA?'':'empty'}">${left}</div><div class="subslot right ${showB?'':'empty'}">${right}</div></div>`;
  }
  function animateAndThen(btn,next){ try{btn.classList.add('opening');btn.setAttribute('disabled','true');}catch(_){}
    setTimeout(next, DOOR_ANIM_MS); }

  // L√≠nea de monedas para F1/F2
  function coinLine(){ if(state.phase==='main') return `<p class="center meta">Monedas obtenidas: <b>${state.coinsF1}</b></p>`;
                      if(state.phase==='phase2') return `<p class="center meta">Monedas obtenidas: <b>${state.coinsF2}</b></p>`;
                      return ''; }

  // Tema por fase
  function applyPhaseTheme(){
    const isP2 = (state.phase === 'phase2');
    document.body.classList.toggle('phase2-theme', isP2);
  }

  /* ====== Pantallas ====== */

  // (1) Demogr√°ficos
  function renderDemographics(){
    screen.innerHTML=html`
      <h1 class="center">¬°Bienvenida/o al juego de puertas!</h1>
      <div class="spacer"></div>
      <div class="field" style="gap:14px;">
        <label>Edad:<input id="edad" type="number" min="1" max="99" placeholder="18" required></label>
        <label>Semestre:
          <select id="semestre" required>
            <option value="" selected disabled>Selecciona</option>
            <option value="1ero">1ero</option><option value="3ro">3ro</option>
            <option value="5to">5to</option><option value="7mo">7mo</option>
            <option value="otro">otro</option>
          </select>
        </label>
        <label>Otro (Semestre):<input id="semestre_otro" type="text" placeholder="Especifica" style="display:none;"></label>
      </div>
      <div class="spacer"></div>
      <div class="field" style="gap:14px%;">
        <label>G√©nero:
          <select id="genero" required>
            <option value="" selected disabled>Selecciona</option>
            <option value="masculino">masculino</option><option value="femenino">femenino</option>
            <option value="otro">otro</option>
          </select>
        </label>
        <label>Otro (G√©nero):<input id="genero_otro" type="text" placeholder="Especifica" style="display:none;"></label>
      </div>
      <div class="spacer"></div>
      <div class="footer"><button class="btn" id="continuar" disabled>Continuar</button></div>
      <p class="center small meta">* Todos los campos son obligatorios. ‚ÄúOtro‚Äù requiere especificar.</p>
    `;
    const edad=document.getElementById('edad');
    const semestre=document.getElementById('semestre');
    const semestre_otro=document.getElementById('semestre_otro');
    const genero=document.getElementById('genero');
    const genero_otro=document.getElementById('genero_otro');
    const btn=document.getElementById('continuar');

    function toggleOtros(){ semestre_otro.style.display=(semestre.value==='otro')?'':'none'; genero_otro.style.display=(genero.value==='otro')?'':'none'; }
    function isValid(){ const e=parseInt(edad.value,10); const sem=semestre.value; const gen=genero.value;
      const semOk=(sem!=='otro')||(semestre_otro.value.trim().length>0);
      const genOk=(gen!=='otro')||(genero_otro.value.trim().length>0);
      const edadOk=Number.isFinite(e)&&e>=1&&e<=99; return edadOk&&!!sem&&!!gen&&semOk&&genOk; }
    function updateUI(){ toggleOtros(); btn.disabled=!isValid(); }
    [edad,semestre,semestre_otro,genero,genero_otro].forEach(el=>{el.addEventListener('input',updateUI);el.addEventListener('change',updateUI);});
    updateUI();

    btn.addEventListener('click',()=>{
      if(!isValid()) return;
      state.edad=parseInt(edad.value,10);
      state.semestre=semestre.value==='otro'?semestre_otro.value.trim():semestre.value;
      state.genero=genero.value==='otro'?genero_otro.value.trim():genero.value;
      state.participantID=Math.floor(100000+Math.random()*900000);
      renderInstructionsAB();
    });
  }

  // (2) Instrucciones: A/B
  function renderInstructionsAB(){
    document.body.classList.remove('phase2-theme');

    screen.innerHTML=html`
      <h1 class="center">Instrucciones</h1>
      <p class="center">Tu objetivo es encontrar la mayor cantidad de monedas, las cuales se encontrar√°n en una de las 4 posibles puertas.</p>
      <p class="center">Primero tendr√°s que escoger entre la puerta de la izquierda o la derecha</p>
      <p class="center"><b>Escoge una de las puertas</b></p>
      <div class="doors">
        ${doorHTML('doorA','',false)}
        ${doorHTML('doorB','',true)}
      </div>
      <div class="footer"><button class="btn" id="next" disabled>Continuar</button></div>
    `;
    const doorA=document.getElementById('doorA');
    const doorB=document.getElementById('doorB');
    const next=document.getElementById('next');

    let selection=null; // 'A' | 'B'
    function updateUI(){
      next.disabled = (selection===null);
      doorA.classList.toggle('selected-instruction', selection==='A');
      doorB.classList.toggle('selected-instruction', selection==='B');
    }
    doorA.onclick=()=>{ selection='A'; state.instr_firstChoice='A'; updateUI(); };
    doorB.onclick=()=>{ selection='B'; state.instr_firstChoice='B'; updateUI(); };
    updateUI();

    next.onclick=()=>renderInstructionsSubdoor();
  }

  // (3) Instrucciones: subpuertas
  function renderInstructionsSubdoor(){
    document.body.classList.remove('phase2-theme');

    const first=state.instr_firstChoice||'A';
    screen.innerHTML=html`
      <h1 class="center">Instrucciones</h1>
      <p class="center">Despu√©s de haber escogido una puerta principal, tendr√°s que escoger entre otras dos opciones</p>
      <p class="center"><b>Ahora, escoge una subpuerta</b></p>
      ${subdoorsHTML(first)}
      <div class="footer"><button class="btn" id="go" disabled>Continuar</button></div>
    `;
    const opt0=document.getElementById('opt0');
    const opt1=document.getElementById('opt1');
    const go=document.getElementById('go');
    let selection=null;

    function setSel(which, label){
      selection=label; state.instr_secondChoice=label;
      if(opt0) opt0.classList.toggle('selected-instruction', which===0);
      if(opt1) opt1.classList.toggle('selected-instruction', which===1);
      go.disabled=(selection===null);
    }
    if(opt0) opt0.onclick=()=>setSel(0, first==='A'?'A1':'B1');
    if(opt1) opt1.onclick=()=>setSel(1, first==='A'?'A2':'B2');
    go.onclick=()=>renderInstructionsFeedback();
  }

  // (4) Instrucciones: feedback
  function renderInstructionsFeedback(){
    document.body.classList.remove('phase2-theme');

    screen.innerHTML=html`
      <h1 class="center">Instrucciones</h1>
      <p class="center">Si la puerta es la correcta, saldr√° una moneda. En caso contrario, saldr√° una cruz roja</p>
      <p class="center">Despu√©s, volver√°s a las puertas principales</p>
      <div class="example-grid">
        <div class="example-card">${feedbackHTML(true)}</div>
        <div class="example-card">${feedbackHTML(false)}</div>
      </div>
      <div class="footer"><button class="btn" id="toNotice">Continuar</button></div>
    `;
    document.getElementById('toNotice').onclick=()=>renderNotice();
  }

  // (5) Aviso
  function renderNotice(){
    document.body.classList.remove('phase2-theme');

    screen.innerHTML=html`
      <h1 class="center">Aviso</h1>
      <p class="center">A continuaci√≥n, podr√°s tener unos juegos de prueba antes de pasar al verdadero. O puedes regresar a las instrucciones</p>
      <p class="center"><b>¬øDeseas continuar, o regresar a las instrucciones?</b></p>
      <div class="footer">
        <button class="btn secondary" id="btnInstr">Instrucciones</button>
        <button class="btn" id="btnPractice">Prueba</button>
      </div>
    `;
    document.getElementById('btnInstr').onclick=()=>renderInstructionsAB();
    document.getElementById('btnPractice').onclick=()=>startPractice();
  }

  /* ====== Pr√°ctica ====== */
  function startPractice(){
    state.phase='practice';
    state.programMode=URL_MODE;
    state.maxTrials=PRACTICE_TRIALS;
    state.trial=0; state.block=1;
    if(state.sessionStartMs===null) state.sessionStartMs=now();
    state.entStartMs=now();

    applyPhaseTheme(); // madera
    initProgram(); renderFirst();
  }

  /* ====== Fase 1 ====== */
  function startMain(){
    state.phase='main';
    state.programMode=URL_MODE;
    state.maxTrials=URL_TRIALS;
    state.trial=0; state.block=1;
    state.coinsF1=0;
    if(state.sessionStartMs===null) state.sessionStartMs=now();
    state.f1StartMs=now();

    applyPhaseTheme(); // madera
    initProgram(); renderFirst();
  }

  // Aviso Fase 2
  function renderPhase2Notice(){
    document.body.classList.remove('phase2-theme'); // a√∫n no F2
    screen.innerHTML=html`
      <h1 class="center">Aviso</h1>
      <p class="center">Ahora se agreg√≥ una pista para facilitar que ganes puntos, deber√°s descubrirla por tu cuenta</p>
      <p class="center">Consigue la mayor cantidad de puntos. ¬°Suerte!</p>
      <p class="center">Oprime Continuar para iniciar</p>
      <div class="footer"><button class="btn" id="goPhase2">Continuar</button></div>
    `;
    document.getElementById('goPhase2').onclick=()=>startPhase2();
  }

  /* ====== Fase 2 ====== */
  function startPhase2(){
    state.phase='phase2';
    state.programMode=URL_MODE;
    state.maxTrials=URL_TRIALS;
    state.trial=0; state.block=1;
    state.coinsF2=0;
    const forcedIdx=forbidIndexFromParam(URL_FORBID);
    state.phase2_forbidden=(forcedIdx!==null)?forcedIdx:Math.floor(Math.random()*4);
    state.f2StartMs=now();

    applyPhaseTheme(); // rojo
    initProgram(); renderFirst();
  }

  /* ====== Ensayo Paso 1 ====== */
  function renderFirst(){
    state.trial+=1;
    state.firstChoice=null; state.secondChoice=null;
    state.trialStartMs=now(); state.firstChoiceMs=null;
    state.tmpRTPrimera=null; state.tmpRTSegunda=null;

    screen.innerHTML=html`
      ${state.phase==='practice' ? '<h2 class="center">Prueba</h2>' : ''}
      <h2 class="center">Elige una puerta principal</h2>
      ${coinLine()}
      <div class="doors">
        ${doorHTML('A','',false)}
        ${doorHTML('B','',true)}
      </div>
    `;

    const a=document.getElementById('A');
    const b=document.getElementById('B');

    a.onclick=()=>{ if(state.tmpRTPrimera===null) state.tmpRTPrimera=secs(now()-state.trialStartMs);
      state.firstChoice='A'; state.firstChoiceMs=now();
      a.setAttribute('disabled','true'); b.setAttribute('disabled','true');
      animateAndThen(a, renderSecond);
    };
    b.onclick=()=>{ if(state.tmpRTPrimera===null) state.tmpRTPrimera=secs(now()-state.trialStartMs);
      state.firstChoice='B'; state.firstChoiceMs=now();
      a.setAttribute('disabled','true'); b.setAttribute('disabled','true');
      animateAndThen(b, renderSecond);
    };
  }

  /* ====== Ensayo Paso 2 ====== */
  function renderSecond(){
    const first=state.firstChoice;
    screen.innerHTML=html`
      ${state.phase==='practice' ? '<h2 class="center">Prueba</h2>' : ''}
      <h2 class="center">Ahora elige una sub-puerta</h2>
      ${coinLine()}
      ${subdoorsHTML(first)}
    `;

    const opt0=document.getElementById('opt0');
    const opt1=document.getElementById('opt1');
    const label0 = first==='A'?'A1':'B1';
    const label1 = first==='A'?'A2':'B2';

    if(opt0) opt0.onclick=()=>{ if(state.firstChoiceMs) state.tmpRTSegunda=secs(now()-state.firstChoiceMs);
      state.secondChoice=label0;
      if(opt1) opt1.setAttribute('disabled','true');
      animateAndThen(opt0, renderFeedback);
    };
    if(opt1) opt1.onclick=()=>{ if(state.firstChoiceMs) state.tmpRTSegunda=secs(now()-state.firstChoiceMs);
      state.secondChoice=label1;
      if(opt0) opt0.setAttribute('disabled','true');
      animateAndThen(opt1, renderFeedback);
    };
  }

  /* ====== Feedback + registro ====== */
  function renderFeedback(){
    const idx=(state.firstChoice==='A') ? (state.secondChoice==='A1'?0:1) : (state.secondChoice==='B1'?2:3);
    const seq=SEQS[idx];
    const target=SEQS[state.currentTarget];
    const rewarded=(idx===state.currentTarget);

    if(rewarded){
      if(phaseCode()==='F1') state.coinsF1 += 1;
      if(phaseCode()==='F2') state.coinsF2 += 1;
      advanceOnReward();
    }

    if(state.sessionStartMs===null) state.sessionStartMs=now();
    const tGlobal=secs(now()-state.sessionStartMs);
    const phase=phaseCode();
    const tENT=(phase==='ENT'&&state.entStartMs)?secs(now()-state.entStartMs):'0';
    const tF1 =(phase==='F1' &&state.f1StartMs)?secs(now()-state.f1StartMs):'0';
    const tF2 =(phase==='F2' &&state.f2StartMs)?secs(now()-state.f2StartMs):'0';

    state.globalTrial+=1;
    state.rows.push({
      Num_Ensayo: state.globalTrial,
      Tiempo_Global: tGlobal,
      Tiempo_ENT: tENT,
      Tiempo_F1: tF1,
      Tiempo_F2: tF2,
      Respuesta: seq,
      Res_Correcta: target,
      Fase: phase,
      Grupo: groupLabel(),
      Puerta_F2: forbiddenSeqLabel(),
      Edad: state.edad,
      Genero: state.genero,
      Semestre: state.semestre,
      ID: state.participantID,
      rt_primera: state.tmpRTPrimera ?? '',
      rt_segunda: state.tmpRTSegunda ?? '',
      Detecto_Regla: state.postRuleDetected ?? '',
      Regla_Texto: state.postRuleText ?? '',
      Detecto_Estrategia: state.postStrategyDetected ?? '',
      Estrategia_Texto: state.postStrategyText ?? '',
      Mas_Monedas_F1: state.postF1MoreCoins ?? '',
      Menos_Monedas_F1: state.postF1LessCoins ?? '',
      Mas_Monedas_F2: state.postF2MoreCoins ?? '',
      Menos_Monedas_F2: state.postF2LessCoins ?? '',
      Comentario: state.postComment ?? ''
    });

    const coinsTxt = (phase==='F1') ? state.coinsF1 : (phase==='F2' ? state.coinsF2 : null);
    screen.innerHTML=html`
      ${feedbackHTML(rewarded)}
      ${coinsTxt!==null ? `<p class="center meta">Monedas obtenidas: <b>${coinsTxt}</b></p>` : ''}
      <div class="footer">
        <button class="btn" id="next">
          ${state.trial < state.maxTrials ? 'Continuar'
            : (state.phase==='practice' ? 'Terminar prueba'
            : (state.phase==='main' ? 'Continuar'
            : 'Finalizar'))}
        </button>
      </div>
    `;
    document.getElementById('next').onclick=()=>{
      if(state.trial < state.maxTrials){
        renderFirst();
      }else{
        if(state.phase==='practice') renderPracticeEnd();
        else if(state.phase==='main') renderPhase2Notice();
        else renderRuleQuestion(); // al terminar F2 ‚Üí preguntas
      }
    };
  }

  // === Pregunta 1: Detecci√≥n de regla ===
  function renderRuleQuestion(){
    screen.innerHTML = html`
      <h2 class="center">Pregunta</h2>
      <p class="center">¬øDetectaste alguna regla en el juego?</p>
      <div class="choices">
        <button class="choice" id="yesBtn">S√≠</button>
        <button class="choice" id="noBtn">No</button>
      </div>
      <div id="ruleBox" style="display:none; margin-top:10px;">
        <p class="center">¬øCu√°l?</p>
        <div class="footer" style="flex-direction:column;">
          <textarea id="ruleText" rows="4" placeholder="Escribe tu respuesta aqu√≠..."></textarea>
        </div>
      </div>
      <div class="footer" style="margin-top:14px;">
        <button class="btn" id="ruleNext" disabled>Continuar</button>
      </div>
    `;

    const yesBtn = document.getElementById('yesBtn');
    const noBtn  = document.getElementById('noBtn');
    const ruleBox = document.getElementById('ruleBox');
    const ruleTxt = document.getElementById('ruleText');
    const next = document.getElementById('ruleNext');

    let sel = null; // 'Si' | 'No'

    function updateUI(){
      next.disabled = (sel===null);
      yesBtn.classList.toggle('selected', sel==='Si');
      noBtn.classList.toggle('selected', sel==='No');
      ruleBox.style.display = (sel==='Si') ? '' : 'none';
    }
    yesBtn.onclick = ()=>{ sel='Si'; updateUI(); };
    noBtn.onclick  = ()=>{ sel='No'; updateUI(); };

    next.onclick = ()=>{
      state.postRuleDetected = sel;
      state.postRuleText = (sel==='Si') ? (ruleTxt.value || '') : '';
      renderStrategyQuestion();
    };

    updateUI();
  }

  // === Pregunta 2: Estrategia ===
  function renderStrategyQuestion(){
    screen.innerHTML = html`
      <h2 class="center">Pregunta</h2>
      <p class="center">¬øSeguiste alguna estrategia para escoger puertas?</p>
      <div class="choices">
        <button class="choice" id="yesBtn">S√≠</button>
        <button class="choice" id="noBtn">No</button>
      </div>
      <div id="stratBox" style="display:none; margin-top:10px;">
        <p class="center">¬øCu√°l?</p>
        <div class="footer" style="flex-direction:column;">
          <textarea id="stratText" rows="4" placeholder="Escribe tu respuesta aqu√≠..."></textarea>
        </div>
      </div>
      <div class="footer" style="margin-top:14px;">
        <button class="btn" id="stratNext" disabled>Continuar</button>
      </div>
    `;

    const yesBtn = document.getElementById('yesBtn');
    const noBtn  = document.getElementById('noBtn');
    const stratBox = document.getElementById('stratBox');
    const stratTxt = document.getElementById('stratText');
    const next = document.getElementById('stratNext');

    let sel = null; // 'Si' | 'No'

    function updateUI(){
      next.disabled = (sel===null);
      yesBtn.classList.toggle('selected', sel==='Si');
      noBtn.classList.toggle('selected', sel==='No');
      stratBox.style.display = (sel==='Si') ? '' : 'none';
    }
    yesBtn.onclick = ()=>{ sel='Si'; updateUI(); };
    noBtn.onclick  = ()=>{ sel='No'; updateUI(); };

    next.onclick = ()=>{
      state.postStrategyDetected = sel;
      state.postStrategyText = (sel==='Si') ? (stratTxt.value || '') : '';
      // Propaga respuestas previas a filas
      for(const r of state.rows){
        r.Detecto_Regla       = state.postRuleDetected ?? '';
        r.Regla_Texto         = state.postRuleText ?? '';
        r.Detecto_Estrategia  = state.postStrategyDetected ?? '';
        r.Estrategia_Texto    = state.postStrategyText ?? '';
      }
      renderF1MoreCoinsQuestion();
    };

    updateUI();
  }

  // === Pregunta 3: ¬øalguna puerta daba M√ÅS monedas en F1? ===
  function renderF1MoreCoinsQuestion(){
    document.body.classList.remove('phase2-theme'); // tema madera

    screen.innerHTML = html`
      <h2 class="center">Pregunta</h2>
      <p class="center">En la primera parte, ¬øconsideras que alguna puerta daba <b>M√ÅS</b> monedas?</p>
      <p class="center small meta">Selecciona la opci√≥n que consideres adecuada</p>
      <div id="f1qArea" style="margin-top:8px;"></div>
      <div class="choices">
        <button class="choice" id="btnEqual">Todas daban igual</button>
      </div>
      <div class="footer">
        <button class="btn" id="next" disabled>Continuar</button>
      </div>
    `;

    const area = document.getElementById('f1qArea');
    const btnEqual = document.getElementById('btnEqual');
    const next = document.getElementById('next');

    let primary = null;      // 'A' | 'B'
    let subSel  = null;      // 'II' | 'ID' | 'DI' | 'DD'
    let equal   = false;

    function updateContinue(){ next.disabled = !(equal || subSel !== null); }

    function renderPrimary(){
      area.innerHTML = `
        <div class="doors">
          ${doorHTML('qA','',false)}
          ${doorHTML('qB','',true)}
        </div>
      `;
      const qA = document.getElementById('qA');
      const qB = document.getElementById('qB');
      qA.onclick = ()=>{ primary='A'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
      qB.onclick = ()=>{ primary='B'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
    }

    function renderSub(){
      area.innerHTML = `
        <p class="center small meta">Si escogiste la puerta que no quer√≠as, puedes regresar a las principales</p>
        <div class="footer"><button class="btn secondary" id="backMain">Regresar a las puertas principales</button></div>
        ${subdoorsHTML(primary)}
      `;
      document.getElementById('backMain').onclick = ()=>{ primary=null; subSel=null; renderPrimary(); updateContinue(); };

      const opt0 = document.getElementById('opt0');
      const opt1 = document.getElementById('opt1');
      function setSelected(which){
        if(opt0) opt0.classList.remove('selected-instruction');
        if(opt1) opt1.classList.remove('selected-instruction');
        if(which===0 && opt0) opt0.classList.add('selected-instruction');
        if(which===1 && opt1) opt1.classList.add('selected-instruction');
      }
      if (opt0) opt0.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'II' : 'DI';
        setSelected(0); updateContinue();
      };
      if (opt1) opt1.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'ID' : 'DD';
        setSelected(1); updateContinue();
      };
    }

    btnEqual.onclick = ()=>{
      equal = true; subSel = null;
      btnEqual.classList.add('selected');
      const o0 = document.getElementById('opt0'); const o1 = document.getElementById('opt1');
      if(o0) o0.classList.remove('selected-instruction');
      if(o1) o1.classList.remove('selected-instruction');
      updateContinue();
    };

    next.onclick = ()=>{
      state.postF1MoreCoins = equal ? 'Todas' : subSel;
      for (const r of state.rows) r.Mas_Monedas_F1 = state.postF1MoreCoins ?? '';
      renderF1LessCoinsQuestion();
    };

    renderPrimary(); updateContinue();
  }

  // === Pregunta 4: ¬øalguna puerta daba MENOS monedas en F1? ===
  function renderF1LessCoinsQuestion(){
    document.body.classList.remove('phase2-theme'); // tema madera

    screen.innerHTML = html`
      <h2 class="center">Pregunta</h2>
      <p class="center">En la primera parte, ¬øconsideras que alguna puerta daba <b>MENOS</b> monedas?</p>
      <p class="center small meta">Selecciona la opci√≥n que consideres adecuada</p>
      <div id="f1qAreaLess" style="margin-top:8px;"></div>
      <div class="choices">
        <button class="choice" id="btnEqualLess">Todas daban igual</button>
      </div>
      <div class="footer">
        <button class="btn" id="nextLess" disabled>Continuar</button>
      </div>
    `;

    const area = document.getElementById('f1qAreaLess');
    const btnEqual = document.getElementById('btnEqualLess');
    const next = document.getElementById('nextLess');

    let primary = null; let subSel  = null; let equal   = false;

    function updateContinue(){ next.disabled = !(equal || subSel !== null); }

    function renderPrimary(){
      area.innerHTML = `
        <div class="doors">
          ${doorHTML('qLA','',false)}
          ${doorHTML('qLB','',true)}
        </div>
      `;
      const qA = document.getElementById('qLA');
      const qB = document.getElementById('qLB');
      qA.onclick = ()=>{ primary='A'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
      qB.onclick = ()=>{ primary='B'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
    }

    function renderSub(){
      area.innerHTML = `
        <p class="center small meta">Si escogiste la puerta que no quer√≠as, puedes regresar a las principales</p>
        <div class="footer"><button class="btn secondary" id="backMainLess">Regresar a las puertas principales</button></div>
        ${subdoorsHTML(primary)}
      `;
      document.getElementById('backMainLess').onclick = ()=>{ primary=null; subSel=null; renderPrimary(); updateContinue(); };

      const opt0 = document.getElementById('opt0');
      const opt1 = document.getElementById('opt1');
      function setSelected(which){
        if(opt0) opt0.classList.remove('selected-instruction');
        if(opt1) opt1.classList.remove('selected-instruction');
        if(which===0 && opt0) opt0.classList.add('selected-instruction');
        if(which===1 && opt1) opt1.classList.add('selected-instruction');
      }
      if (opt0) opt0.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'II' : 'DI';
        setSelected(0); updateContinue();
      };
      if (opt1) opt1.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'ID' : 'DD';
        setSelected(1); updateContinue();
      };
    }

    btnEqual.onclick = ()=>{
      equal = true; subSel = null;
      btnEqual.classList.add('selected');
      const o0 = document.getElementById('opt0'); const o1 = document.getElementById('opt1');
      if(o0) o0.classList.remove('selected-instruction');
      if(o1) o1.classList.remove('selected-instruction');
      updateContinue();
    };

    next.onclick = ()=>{
      state.postF1LessCoins = equal ? 'Todas' : subSel;
      for (const r of state.rows) r.Menos_Monedas_F1 = state.postF1LessCoins ?? '';
      renderF2MoreCoinsQuestion(); // ‚Üê ahora vamos a las preguntas de F2
    };

    renderPrimary(); updateContinue();
  }

  // === Pregunta 5: ¬øalguna puerta daba M√ÅS monedas en F2? (puertas rojas) ===
  function renderF2MoreCoinsQuestion(){
    // Forzar tema rojo de F2 para esta pregunta
    document.body.classList.add('phase2-theme');

    screen.innerHTML = html`
      <h2 class="center">Pregunta</h2>
      <p class="center">En la segunda parte, ¬øconsideras que alguna puerta daba <b>M√ÅS</b> monedas?</p>
      <p class="center small meta">Selecciona la opci√≥n que consideres adecuada</p>
      <div id="f2qAreaMore" style="margin-top:8px;"></div>
      <div class="choices">
        <button class="choice" id="btnEqualF2More">Todas daban igual</button>
      </div>
      <div class="footer">
        <button class="btn" id="nextF2More" disabled>Continuar</button>
      </div>
    `;

    const area = document.getElementById('f2qAreaMore');
    const btnEqual = document.getElementById('btnEqualF2More');
    const next = document.getElementById('nextF2More');

    let primary = null; let subSel  = null; let equal   = false;

    function updateContinue(){ next.disabled = !(equal || subSel !== null); }

    function renderPrimary(){
      area.innerHTML = `
        <div class="doors">
          ${doorHTML('qFA','',false)}
          ${doorHTML('qFB','',true)}
        </div>
      `;
      const qA = document.getElementById('qFA');
      const qB = document.getElementById('qFB');
      qA.onclick = ()=>{ primary='A'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
      qB.onclick = ()=>{ primary='B'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
    }

    function renderSub(){
      area.innerHTML = `
        <p class="center small meta">Si escogiste la puerta que no quer√≠as, puedes regresar a las principales</p>
        <div class="footer"><button class="btn secondary" id="backMainF2More">Regresar a las puertas principales</button></div>
        ${subdoorsHTML(primary)}
      `;
      document.getElementById('backMainF2More').onclick = ()=>{ primary=null; subSel=null; renderPrimary(); updateContinue(); };

      const opt0 = document.getElementById('opt0');
      const opt1 = document.getElementById('opt1');
      function setSelected(which){
        if(opt0) opt0.classList.remove('selected-instruction');
        if(opt1) opt1.classList.remove('selected-instruction');
        if(which===0 && opt0) opt0.classList.add('selected-instruction');
        if(which===1 && opt1) opt1.classList.add('selected-instruction');
      }
      if (opt0) opt0.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'II' : 'DI';
        setSelected(0); updateContinue();
      };
      if (opt1) opt1.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'ID' : 'DD';
        setSelected(1); updateContinue();
      };
    }

    btnEqual.onclick = ()=>{
      equal = true; subSel = null;
      btnEqual.classList.add('selected');
      const o0 = document.getElementById('opt0'); const o1 = document.getElementById('opt1');
      if(o0) o0.classList.remove('selected-instruction');
      if(o1) o1.classList.remove('selected-instruction');
      updateContinue();
    };

    next.onclick = ()=>{
      state.postF2MoreCoins = equal ? 'Todas' : subSel;
      for (const r of state.rows) r.Mas_Monedas_F2 = state.postF2MoreCoins ?? '';
      renderF2LessCoinsQuestion();
    };

    renderPrimary(); updateContinue();
  }

  // === Pregunta 6: ¬øalguna puerta daba MENOS monedas en F2? (puertas rojas) ===
  function renderF2LessCoinsQuestion(){
    // Forzar tema rojo de F2 para esta pregunta
    document.body.classList.add('phase2-theme');

    screen.innerHTML = html`
      <h2 class="center">Pregunta</h2>
      <p class="center">En la segunda parte, ¬øconsideras que alguna puerta daba <b>MENOS</b> monedas?</p>
      <p class="center small meta">Selecciona la opci√≥n que consideres adecuada</p>
      <div id="f2qAreaLess" style="margin-top:8px;"></div>
      <div class="choices">
        <button class="choice" id="btnEqualF2Less">Todas daban igual</button>
      </div>
      <div class="footer">
        <button class="btn" id="nextF2Less" disabled>Continuar</button>
      </div>
    `;

    const area = document.getElementById('f2qAreaLess');
    const btnEqual = document.getElementById('btnEqualF2Less');
    const next = document.getElementById('nextF2Less');

    let primary = null; let subSel  = null; let equal   = false;

    function updateContinue(){ next.disabled = !(equal || subSel !== null); }

    function renderPrimary(){
      area.innerHTML = `
        <div class="doors">
          ${doorHTML('qF2LA','',false)}
          ${doorHTML('qF2LB','',true)}
        </div>
      `;
      const qA = document.getElementById('qF2LA');
      const qB = document.getElementById('qF2LB');
      qA.onclick = ()=>{ primary='A'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
      qB.onclick = ()=>{ primary='B'; equal=false; btnEqual.classList.remove('selected'); renderSub(); updateContinue(); };
    }

    function renderSub(){
      area.innerHTML = `
        <p class="center small meta">Si escogiste la puerta que no quer√≠as, puedes regresar a las principales</p>
        <div class="footer"><button class="btn secondary" id="backMainF2Less">Regresar a las puertas principales</button></div>
        ${subdoorsHTML(primary)}
      `;
      document.getElementById('backMainF2Less').onclick = ()=>{ primary=null; subSel=null; renderPrimary(); updateContinue(); };

      const opt0 = document.getElementById('opt0');
      const opt1 = document.getElementById('opt1');
      function setSelected(which){
        if(opt0) opt0.classList.remove('selected-instruction');
        if(opt1) opt1.classList.remove('selected-instruction');
        if(which===0 && opt0) opt0.classList.add('selected-instruction');
        if(which===1 && opt1) opt1.classList.add('selected-instruction');
      }
      if (opt0) opt0.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'II' : 'DI';
        setSelected(0); updateContinue();
      };
      if (opt1) opt1.onclick = ()=>{
        equal=false; btnEqual.classList.remove('selected');
        subSel = (primary==='A') ? 'ID' : 'DD';
        setSelected(1); updateContinue();
      };
    }

    btnEqual.onclick = ()=>{
      equal = true; subSel = null;
      btnEqual.classList.add('selected');
      const o0 = document.getElementById('opt0'); const o1 = document.getElementById('opt1');
      if(o0) o0.classList.remove('selected-instruction');
      if(o1) o1.classList.remove('selected-instruction');
      updateContinue();
    };

    next.onclick = ()=>{
      state.postF2LessCoins = equal ? 'Todas' : subSel;
      for (const r of state.rows) r.Menos_Monedas_F2 = state.postF2LessCoins ?? '';
      renderCommentScreen(); // ‚Üê NUEVO: antes del fin, pedir comentario
    };

    renderPrimary(); updateContinue();
  }

  // ===== NUEVO: L√°mina de COMENTARIO =====
  function renderCommentScreen(){
    screen.innerHTML = html`
      <h2 class="center">Comentario</h2>
      <p class="center">Si quieres agregar un comentario, puedes hacerlo debajo. Si no, oprime Continuar</p>
      <div class="footer" style="flex-direction:column;gap:10px;">
        <textarea id="commentBox" rows="4" placeholder="Escribe tu comentario (opcional)..."></textarea>
      </div>
      <div class="footer">
        <button class="btn" id="commentNext">Continuar</button>
      </div>
    `;
    const box = document.getElementById('commentBox');
    // si ya exist√≠a algo (volver atr√°s), repoblar
    if (state.postComment) box.value = state.postComment;

    document.getElementById('commentNext').onclick = ()=>{
      state.postComment = (box.value || '').trim();
      // Propagar a filas (para CSV/JSON/Sheets)
      for (const r of state.rows) r.Comentario = state.postComment;
      renderFinalEnd();
    };
  }

  // Fin pr√°ctica
  function renderPracticeEnd(){
    const got = state.rows.filter(r=>r.Fase==='ENT' && r.Respuesta===r.Res_Correcta).length;
    screen.innerHTML=html`
      <h2 class="center">Fin de la prueba</h2>
      <p class="center">Monedas obtenidas: <b>${got}</b></p>
      <div class="footer"><button class="btn" id="startMain">Empezar</button></div>
    `;
    document.getElementById('startMain').onclick=()=>startMain();
  }

  // Fin total
  function renderFinalEnd(){ sendToSheets(state.rows); renderFinalSummary(); }
  function renderFinalSummary(){
    screen.innerHTML=html`
      <h2 class="center">Fin</h2>
      <p class="center">Monedas obtenidas en la primera parte: <b>${state.coinsF1}</b></p>
      <p class="center">Monedas obtenidas en la segunda parte: <b>${state.coinsF2}</b></p>
      <div class="footer"><button class="btn" id="admin">√Årea de datos</button></div>
      <p class="center small meta">* Acceso privado para quien recolecta los datos.</p>
    `;
    document.getElementById('admin').onclick=()=>renderAdminGate();
  }

  // Gate admin
  function renderAdminGate(){
    screen.innerHTML=html`
      <h2 class="center">√Årea de datos (privada)</h2>
      <p class="center small">Ingresa la contrase√±a para continuar.</p>
      <div class="footer">
        <input id="pass" type="password" placeholder="Contrase√±a" />
        <button class="btn" id="go">Entrar</button>
        <button class="btn secondary" id="back">Volver</button>
      </div>
      <p id="err" class="center small" style="color: var(--warn); display:none;">Contrase√±a incorrecta.</p>
    `;
    const pass=document.getElementById('pass'); const err=document.getElementById('err');
    document.getElementById('go').onclick=()=>{ if(pass.value===ADMIN_PASS) renderAdminPanel(); else { err.style.display='block'; pass.value=''; pass.focus(); } };
    document.getElementById('back').onclick=()=>renderFinalSummary();
    pass.addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('go').click(); });
  }

  // Panel admin
  function renderAdminPanel(){
    screen.innerHTML=html`
      <h2 class="center">Panel de datos</h2>
      <div class="footer">
        <button class="btn" id="dlcsv">Descargar CSV</button>
        <button class="btn secondary" id="dljson">Descargar JSON</button>
        <button class="btn" id="back">Volver</button>
      </div>
      <p class="center small meta">* Este panel no es visible para participantes sin contrase√±a.</p>
    `;
    document.getElementById('dlcsv').onclick=()=>download('datos_puertas.csv', toCSVOrdered(state.rows, CSV_HEADERS), 'text/csv;charset=utf-8');
    document.getElementById('dljson').onclick=()=>download('datos_puertas.json', JSON.stringify(state.rows,null,2), 'application/json');
    document.getElementById('back').onclick=()=>renderFinalSummary();
  }

  // Inicio
  window.addEventListener('load',()=>{ renderDemographics(); });
  </script>
</body>
</html>
